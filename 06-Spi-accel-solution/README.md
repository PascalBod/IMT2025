# SPI exercise solution

## How the project was created

Start from *Empty C Project* with BRD2601B Rev A01 board as target.

Add following components:
* **Services > Timers > Sleep Timer**
* **Services > IO Stream > IO Stream: STDLIB Configuration**
* **Services > IO Stream > Driver > IO Stream: USART** - instance name: `vcom`
* **Services > IO Stream > IO Stream: Retarget STDIO**
* **Platform > Peripheral > EUSART**
* **Application > Utility > Log**

USART0 is for log messages. EUSART1 is for SPI. EUSART0 can't be used, as it can't be connected to PC port. See EFR32MG24 Datasheet section 6.7.

The **Platform > Board > Board Control** component allows to enable the IMU. The related option is not set, to keep full control on the IMU.

Silicon Labs provides two components supporting the ICM-20689:
* **Platform > Board Drivers > ICM20689 - Motion Sensor**
* **IMU - Device driver for InvenSense ICM-20689**

The exercise does not use them, in order to demonstrate in a simple way how to handle an SPI peripheral. A production-grade application should use these components (after having checked they are reliable).

## Solution

### Maximum number of provided samples

The maximum number per second  of samples that can be provided by the IMU is 1000. See section 11.9 of the datasheet.

### Time to retrieve on acceleration sample

Reading an acceleration sample requires the following SPI exchanges:
* TX: 8 bits
* RX: 6 x 8 bits

This is a total of 56 bits. One bit requires one clock cycle. Clock frequency is set to 3.3 MHz. Consequently, exchanging one sample requires 56 / 3300000 = 17 Âµs. 

The above calculation does not take into account the time required to select/deselect the IMU.

### Maximum number of samples retrieved per second

The above period corresponds to a 59 kHz frequency: 59,000 samples per second can be retrieved. This is far more than the maximum number of provided samples.

### Sample loss

The current application waits for a minimum of 100 ms (`READ_PERIOD_MS`) before retrieving a new sample. As samples are generated by the IMU at a 5 Hz rate, there should be no problem.

But `app_process_action` is called periodically by the main loop of `main`. If the other function of the loop, `sl_system_process_action`, takes too much time, the application could miss a sample. Note: this is not the case. `sl_system_process_action` is written so that its execution time is short.

### Application deficiency

The application does not know when a new sample is available. Said in another way: it may retrieve the same sample several times in line. This is the case with the current retrieval rate.

A better architecture will be presented further in the course.